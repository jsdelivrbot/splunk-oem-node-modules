import path from 'path';
import webpack from 'webpack';

const LiveReloadPlugin = require('webpack-livereload-plugin');

/**
 * Runs webpack with the provided options.
 */
function runWebpack(options) {
    return new Promise((resolve, reject) => {
        const { configPath, watch } = options;
        const config = require(path.resolve(configPath)); // eslint-disable-line global-require
        if (watch) {
            config.plugins.push(new LiveReloadPlugin({
                appendScriptTag: true,
            }));
        }
        const compiler = webpack(config.default ? config.default : config);

        function compileHandler(err, stats) {
            if (err) {
                reject(err);
            } else {
                console.log(stats.toString(config.stats)); // eslint-disable-line no-console
                if (!watch) {
                    resolve();
                }
            }
        }

        if (watch) {
            compiler.watch({}, compileHandler);
        } else {
            compiler.run(compileHandler);
        }
    });
}

export default runWebpack;
